\documentclass[tikz,border=3pt]{standalone}

\usepackage{amsmath,amssymb}
\usepackage{xcolor}
\usetikzlibrary{calc}
\usetikzlibrary{positioning}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{matrix}
\usetikzlibrary{fit}
\usetikzlibrary{quotes}
\usetikzlibrary{graphs}
\usetikzlibrary{intersections}
\usetikzlibrary {backgrounds}

\usepackage{listofitems} % for \readlist to create arrays
\usepackage{svg}

\pgfdeclarelayer{middle}
\pgfdeclarelayer{middle2}

\pgfsetlayers{background,middle2,  middle,  main}

\begin{document}

\definecolor{c1}{RGB}{239,243,255}
\definecolor{c2}{RGB}{198,219,239}
\definecolor{c3}{RGB}{158,202,225}
\definecolor{c4}{RGB}{107,174,214}
\definecolor{c5}{RGB}{66,146,198}
\definecolor{c6}{RGB}{33,113,181}
\definecolor{c7}{RGB}{8,69,148}

\definecolor{p1}{RGB}{254,224,210}
\definecolor{p2}{RGB}{252,146,114}
\definecolor{p3}{RGB}{222,45,38}

% \definecolor{l1}{RGB}{117,107,177}

\definecolor{l1}{RGB}{42,240,247}
\definecolor{l2}{RGB}{218,218,235}
\definecolor{l3}{RGB}{188,189,220}
\definecolor{l4}{RGB}{158,154,200}
\definecolor{l5}{RGB}{128,125,186}
\definecolor{l6}{RGB}{106,81,163}
\definecolor{l7}{RGB}{74,20,134}


\definecolor{q1}{RGB}{242,240,247}
\definecolor{q2}{RGB}{218,218,235}
\definecolor{q3}{RGB}{188,189,220}
\definecolor{q4}{RGB}{158,154,200}
\definecolor{q5}{RGB}{117,107,177}
\definecolor{q6}{RGB}{84,39,143}

\colorlet{myred}{red!80!black}
\colorlet{myblue}{blue!80!black}
\colorlet{mygreen}{green!60!black}

\colorlet{myorange}{orange!70!red!60!black}
\colorlet{mydarkred}{red!30!black}
\colorlet{mydarkblue}{blue!40!black}
\colorlet{mydarkgreen}{green!30!black}


\begin{tikzpicture}[
	font=\small, block/.style = {rectangle, draw, text centered, rounded corners, minimum height=4em, minimum width=4em}, qual block/.style = {rectangle, fill=q4, text centered, rounded corners, minimum height=4em, minimum width=4em}, connect/.style={rounded corners, black!40, text=black, line width=2pt, -{Stealth[length=8pt, width=6pt]}, shorten >=1pt, shorten <=1pt},
	model box/.style={rectangle, draw=black!40, thick, rounded corners, inner sep=5pt, fill=c1, minimum width=6cm},
	input box/.style={fill=c1, draw=black!40,  thick, rounded corners, inner sep=5pt, minimum width=6cm},
	output box/.style={fill=c1, draw=black!40, thick, rounded corners, inner sep=5pt,
    minimum width=6cm},
	token node/.style={ draw=black, line width=0.5pt, minimum size=1.2em},
	]
	\def\boxdist{1cm}

	\begin{scope}[local bounding box=nanoporebox]
		\node (nanoporenode) [block,  minimum size=10em] {Nanopore};
	\end{scope}

	% input
	\begin{scope}[shift={(nanoporebox.south)}, yshift=-\boxdist * 1.5, local bounding box=inputbox]
		\matrix (rnaseq) [matrix of nodes, nodes in empty cells,
			column sep=-\pgflinewidth * 3, row sep=1pt,
			nodes={thin, inner sep=1pt,  minimum size=0.8em, anchor=center},
			column 1/.style={nodes={anchor=east}},
			row 3 column 2/.style={nodes={fill=p1, draw=p1}},
			row 3 column 3/.style={nodes={fill=p1, draw=p1}},
			row 3 column 4/.style={nodes={fill=p1, draw=p1}},
			row 3 column 5/.style={nodes={fill=p3, draw=p3}},
			row 3 column 6/.style={nodes={fill=p3, draw=p3}},
			row 3 column 7/.style={nodes={fill=p3, draw=p3}},
			row 3 column 8/.style={nodes={fill=p3, draw=p3}},
			row 3 column 9/.style={nodes={fill=p1, draw=p1}},
			row 3 column 10/.style={nodes={fill=p1, draw=p1}},
			row 3 column 11/.style={nodes={fill=p1, draw=p1}},
		] {
			Seq   & [6pt] T & . & C & A & A & T & G & T & . & G \\
			Qual  & T       & . & C & A & A & T & G & T & . & G \\
			Label & 0       & 0 & 0 & 1 & 1 & 1 & 1 & 0 & 0 & 0 \\
		};
	\end{scope}

	% token
	\begin{scope}[shift={(inputbox.south)}, yshift=-\boxdist * 2, local bounding box=tokenbox]
		\matrix (tokens)   [
			matrix of nodes,
			nodes in empty cells,
			nodes={token node, fill=c2},
			column sep=-\pgflinewidth, row sep=-\pgflinewidth,
			column 1/.style={nodes={fill=c1}},
			column 2/.style={nodes={fill=c2}},
			column 3/.style={nodes={fill=c3}},
			column 4/.style={nodes={fill=c4}},
			column 5/.style={nodes={fill=c5}},
			column 6/.style={nodes={fill=c6}},
			column 7/.style={nodes={fill=c7}},
		]
		{
			 &  &  &  &  &  & \\
		};
	\end{scope}

	\begin{scope}[shift={(tokenbox.south)}, yshift=-\boxdist * 2.5,
        xshift=-7.4em,
		edge1/.style={black, line width=1pt, -{Stealth[length=3pt, width=3pt]}, shorten >=0.5pt, shorten <=0.5pt},
		local bounding box=lcgmlbox, scale=1, transform shape]
		\graph [
			grow right = 0.8cm,
			edges = {edge1},
			skip loop/.style={to path={ -- ++(1cm, 0) -| (\tikztotarget) \tikztonodes}},
			hyena/.style ={rectangle, draw=c7, fill=c7!20, thick,rotate=270,  minimum height=2em, minimum width=5em, font=\large},
			residual/.style={circle, draw=c7, line width=1pt, inner sep=0.1, as=+},
			block1/.style={rectangle, draw=c5, fill=c5!70, thick,   minimum height=3em, minimum width=1em, as=},
			block2/.style={rectangle, draw=c6, fill=c6!70, thick,  minimum height=4em, minimum width=1em, as=},
		] {
			input [inner sep=0, as=] -> hyena [hyena] -> r1 [residual] -> b1 [block1] -> b2 [block2] -> r2 [residual] -> b3 [block1];
		};

		\draw[edge1]  ($(input) !.2! (hyena)$) |- ++(0,1) -| (r1);
		\draw[edge1] ($(b1) !.4! (b2) $) |- ++(0,1) -| (r2);


		\begin{pgfonlayer}{middle}
			\node (lcgmlboxoutline) [fit=(lcgmlbox), fill=l4, draw, rounded corners,  thick, inner sep=6pt, inner ysep=12pt] {};
			\node[inner sep=3pt, anchor=north west] at (lcgmlboxoutline.north west) {Hyena Block};
		\end{pgfonlayer}

		\begin{pgfonlayer}{middle2}
			% Calculate the position and size of the second rectangle
			\coordinate (lcgmlboxoutline_center) at (lcgmlboxoutline.center);
			\path let \p1 = (lcgmlboxoutline.south west), \p2 = (lcgmlboxoutline.north east) in
			node (lcgmlboxoutline2) [draw, fill=l4, thick,rounded corners, minimum width=\x2-\x1, minimum height=\y2-\y1]
			at ([shift={(0.2, 0.2)}]lcgmlboxoutline_center) {};
		\end{pgfonlayer}

		% \node (lcgmlboxoutline2label) [above=4pt of lcgmlboxoutline2] {Long-Context GLM};
	\end{scope}

	% features
	\begin{scope}[shift={(lcgmlbox.south)},
			yshift=-\boxdist,
            xshift=5pt,
			local bounding box=featuresbox]
		\begin{scope}[opacity=0.7]
			\matrix (tokens1)   [
				matrix of nodes,
				nodes in empty cells,
				nodes={token node, fill=c2},
				column sep=-\pgflinewidth, row sep=-\pgflinewidth,
				column 1/.style={nodes={fill=c1}},
				column 2/.style={nodes={fill=c2}},
				column 3/.style={nodes={fill=c3}},
				column 4/.style={nodes={fill=c4}},
				column 5/.style={nodes={fill=c5}},
				column 6/.style={nodes={fill=c6}},
				column 7/.style={nodes={fill=c7}},
			]
			{
				 &  &  &  &  &  & \\
			};
		\end{scope}

		\begin{scope}[shift={(-0.1, -0.1)}, opacity=0.8]
			\matrix (tokens1)   [
				matrix of nodes,
				nodes in empty cells,
				nodes={token node, fill=c2},
				column sep=-\pgflinewidth, row sep=-\pgflinewidth,
				 column 1/.style={nodes={fill=c1}},
				 column 2/.style={nodes={fill=c2}},
				 column 3/.style={nodes={fill=c3}},
				 column 4/.style={nodes={fill=c4}},
				 column 5/.style={nodes={fill=c5}},
				 column 6/.style={nodes={fill=c6}},
				 column 7/.style={nodes={fill=c7}},
			]
			{
                & & & & & &  \\
			};
		\end{scope}

		\begin{scope}[shift={(-0.2, -0.2)}, opacity=1]
			\matrix (tokens1)   [
				matrix of nodes,
				nodes in empty cells,
				nodes={token node, fill=c2},
				column sep=-\pgflinewidth, row sep=-\pgflinewidth,
				 column 1/.style={nodes={fill=c1}},
				 column 2/.style={nodes={fill=c2}},
				 column 3/.style={nodes={fill=c3}},
				 column 4/.style={nodes={fill=c4}},
				 column 5/.style={nodes={fill=c5}},
				 column 6/.style={nodes={fill=c6}},
				 column 7/.style={nodes={fill=c7}},
			]
			{
                & & & & & & \\ 
			};
		\end{scope}
	\end{scope}

	% qual block
	\begin{scope}[shift={(featuresbox.south)}, yshift=-\boxdist, xshift=1.4em, local bounding box=qualblockbox,
			scale=1.5,
			transform shape,
			qual block/.style = {rectangle, fill=q3, text centered, rounded corners, minimum height=1em, minimum width=4em},
			resuidual block/.style = {rectangle, fill=q4, text centered, rounded corners, minimum height=4em, minimum width=6em},
			seq block/.style = {rectangle, fill=q5, text centered, rounded corners, minimum height=1em, minimum width=6em},
		]
		\node [seq block] (sblock) {seq};
		\node [resuidual block, below=1pt of sblock] (rblock) {residual};
		\node [qual block, rotate=270, left=9pt of rblock, xshift=20pt] (qblock) {qual};

		\begin{pgfonlayer}{middle}
			\node (qualblockoutline) [fit=(qblock)(rblock)(sblock), fill=c1, draw, rounded corners,  thick, inner sep=6pt] {};
		\end{pgfonlayer}

		% \node (qualblockoutlinelabel) [above=4pt of qualblockoutline] {Quality Block};
	\end{scope}


	% mlp
	\begin{scope}[shift={(qualblockbox.south)}, yshift=-\boxdist * 0.1,
        xshift=1.27em, 
		>=latex, % for default LaTeX arrow head
		node/.style={thick,circle,draw=myblue,minimum size=22,inner sep=0.5,outer sep=0.6},
		node in/.style={node,green!20!black,draw=mygreen!30!black,fill=mygreen!25},
		node hidden/.style={node,blue!20!black,draw=myblue!30!black,fill=myblue!20},
		node convol/.style={node,orange!20!black,draw=myorange!30!black,fill=myorange!20},
		node out/.style={node,red!20!black,draw=myred!30!black,fill=myred!20},
		connect/.style={thick,mydarkblue}, %,line cap=round
		connect arrow/.style={-{Latex[length=3,width=2]}, line width=0.8pt, mydarkblue,shorten <=0.5,shorten >=1},
		node 1/.style={node hidden},
		node 2/.style={node hidden},
		node 3/.style={node out},
		scale=0.54,
        rotate=270,
		x=2.2cm,
		y=1.4cm,
		transform shape,
		local bounding box=mlpbox]
		\def\nstyle{int(\lay<\Nnodlen?min(2,\lay):3)} % map layer number onto 1, 2, or 3

		\readlist\Nnod{3,4,2} % number of nodes per layer

		\message{^^J  Layer}
		\foreachitem \N \in \Nnod{ % loop over layers
			\edef\lay{\Ncnt} % alias of index of current layer
			\message{\lay,}
			\pgfmathsetmacro\prev{int(\Ncnt-1)} % number of previous layer
			\foreach \i [evaluate={\y=\N/2-\i; \x=\lay; \n=\nstyle;}] in {1,...,\N}{ % loop over nodes
					% NODES
					\node[node \n] (N\lay-\i) at (\x,\y) {};
					%\node[circle,inner sep=2] (N\lay-\i') at (\x-0.15,\y) {}; % shifted node
					%\draw[node] (N\lay-\i) circle (\R);

					% CONNECTIONS
					\ifnum\lay>1 % connect to previous layer
						\foreach \j in {1,...,\Nnod[\prev]}{ % loop over nodes in previous layer
								\draw[connect arrow] (N\prev-\j) -- (N\lay-\i); % connect arrows directly
								%\draw[connect arrow] (N\prev-\j) -- (N\lay-\i'); % connect arrows to shifted node
							}
					\fi % else: nothing to connect first layer
				}
		}
	\end{scope}

	%  output
	\begin{scope}[shift={(mlpbox.south)}, yshift=-\boxdist, local bounding box=outputbox]
		\matrix (outputmatrix) [matrix of nodes, nodes in empty cells,
			column sep=-\pgflinewidth, row sep=-\pgflinewidth,
			nodes={token node, fill=c2},
			row 1/.style={nodes={fill=p1}},
		     row 1 column 3/.style={nodes={fill=p3}},
             row 1 column 5/.style={nodes={fill=p3}},
		] {
            & & & & & & \\ 
		};
	\end{scope}

	%  smoutput
	\begin{scope}[shift={(outputbox.south)}, yshift=-\boxdist * 1.5, local bounding box=smoutputbox]
		\matrix (smoutputmatrix) [matrix of nodes, nodes in empty cells,
			column sep=-\pgflinewidth, row sep=-\pgflinewidth,
			nodes={token node, fill=c2},
			row 1/.style={nodes={fill=p1}},
			row 1 column 3/.style={nodes={fill=p3}},
			row 1 column 4/.style={nodes={fill=p3}},
			row 1 column 5/.style={nodes={fill=p3}},
		] {
            & & & & & & \\ 
		};
	\end{scope}

	% predict
	\begin{scope}[shift={(smoutputbox.south)}, yshift=-\boxdist, local bounding box=predictbox]
			\matrix (predictseq) [matrix of nodes,
				nodes in empty cells,
				column sep=-\pgflinewidth, row sep=3pt,
				nodes={thin, inner sep=0pt,  minimum width=0.6em, minimum height=0.6em, anchor=center},
			] {
                T & $\cdots$ & C & & T & $\cdots$ & G \\
			};
	\end{scope}


	\path [connect]
	(nanoporebox) edge  (inputbox)
	(inputbox)  edge ["\rotatebox{0}{Tokenization}"] (tokenbox)
	(tokenbox) edge (lcgmlbox)
	(lcgmlbox) edge (featuresbox)
	(featuresbox) edge (qualblockbox)
	(mlpbox) edge (outputbox)
	(outputbox) edge["\rotatebox{0}{Polish}", above] (smoutputbox)
	(smoutputbox) edge["\rotatebox{0}{Predict}", above] (predictbox)
	(qualblockbox) edge (mlpbox)
	;


	\begin{scope}[on background layer]
		\node (intputoutline) [fit=(rnaseq)(nanoporenode), input box] {};
		\node (modeloutline) [fit=(tokenbox)(lcgmlbox)(qualblockbox)(mlpbox)(outputbox), model box , inner sep=10pt] {};
		\node[anchor=north west] at (modeloutline.north west) {Model};
		\node (outputoutline) [fit=(predictbox)(smoutputbox), output box] {};
		\node (mlplabel) [left=4pt of mlpbox] {MLP};
        \node (inputlabel) [anchor=north west] at (intputoutline.north west) {Input};
        \node (outputlabel) [anchor=north west] at  (outputoutline.north west) {Output};
	\end{scope}

	% \draw [connect]  ($(intputoutline.south) + (55pt, 10pt)$) -- ++(0, -12pt)  -| ($(qblock) + (0, -14pt)$);

	% \draw [connect]  ($(outputbox.north) + (0, 1pt)$) --  ++(0, 28pt)  -|  node [pos=0.25, fill=white, inner sep=1pt]{Loss} ($(intputoutline.north) + (45pt, -10pt)$);

\end{tikzpicture}


\end{document}
